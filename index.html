<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VTP Editorial | Pro 3D Magazine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/20.0.0/tween.umd.js"></script>
    <style>
        body { margin: 0; background-color: #050a09; overflow: hidden; }
        #canvas-container { width: 100%; height: 100vh; }
        .ui-controls { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; z-index: 100; }
        .btn-flip { background: rgba(57, 197, 187, 0.2); border: 1px solid #39c5bb; color: #39c5bb; padding: 12px 35px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-flip:hover:not(:disabled) { background: #39c5bb; color: white; box-shadow: 0 0 20px #39c5bb; }
        .btn-flip:disabled { opacity: 0.2; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="ui-controls">
        <button id="prevBtn" class="btn-flip">TRANG TRƯỚC</button>
        <button id="nextBtn" class="btn-flip">TRANG TIẾP</button>
    </div>
    <div id="canvas-container"></div>

    <script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }</script>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        const EXT = ".JPG.jpg";
        const frontName = "Tạp Chí_00102";
        const backName = "Tạp Chí_00103";
        const contentPages = [];
        for (let i = 1; i <= 101; i++) contentPages.push(`Tạp Chí_${String(i).padStart(5, '0')}`);
        const ALL_ASSETS = [frontName, ...contentPages, backName];

        let scene, camera, renderer, bookGroup;
        let meshPages = [];
        let currentIndex = 0;
        const W = 16, H = 22;

        function init() {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene();
            
            camera = new THREE.PerspectiveCamera(35, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(0, 0, 80);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            
            // --- CẤU HÌNH MÀU SẮC CHUẨN ---
            renderer.outputColorSpace = THREE.SRGBColorSpace; // Giúp màu không bị bạc
            renderer.toneMapping = THREE.NoToneMapping; 
            container.appendChild(renderer.domElement);

            // Ánh sáng mạnh và đều để giữ màu gốc
            const ambientLight = new THREE.AmbientLight(0xffffff, 4); 
            scene.add(ambientLight);

            bookGroup = new THREE.Group();
            scene.add(bookGroup);

            const loader = new THREE.TextureLoader();

            for (let i = 0; i < ALL_ASSETS.length; i += 2) {
                const geometry = new THREE.BoxGeometry(W, H, 0.06);
                geometry.translate(W/2, 0, 0);

                // Load mặt trước
                const texFront = loader.load(ALL_ASSETS[i] + EXT);
                texFront.colorSpace = THREE.SRGBColorSpace;

                // Load mặt sau
                let texBack = null;
                if (i + 1 < ALL_ASSETS.length) {
                    texBack = loader.load(ALL_ASSETS[i+1] + EXT);
                    texBack.colorSpace = THREE.SRGBColorSpace;
                    // SỬA LỖI LẬT NGƯỢC:
                    texBack.center.set(0.5, 0.5);
                    texBack.repeat.set(-1, 1); 
                }

                const materials = [
                    new THREE.MeshBasicMaterial({ color: 0x111111 }), // cạnh
                    new THREE.MeshBasicMaterial({ color: 0x111111 }),
                    new THREE.MeshBasicMaterial({ color: 0x111111 }),
                    new THREE.MeshBasicMaterial({ color: 0x111111 }),
                    new THREE.MeshBasicMaterial({ map: texFront }), // Mặt lẻ (Phải)
                    new THREE.MeshBasicMaterial({ map: texBack ? texBack : null, color: texBack ? 0xffffff : 0x000000 }) // Mặt chẵn (Trái)
                ];

                const page = new THREE.Mesh(geometry, materials);
                page.position.z = -(i * 0.03); // Xếp chồng trang
                
                bookGroup.add(page);
                meshPages.push(page);
            }

            bookGroup.position.x = -W/2;
            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            
            animate();
            updateUI();
        }

        function flip(direction) {
            if (direction === 'next' && currentIndex < meshPages.length - 1) {
                const page = meshPages[currentIndex];
                // Lật trang và đẩy Z lên để không bị đè
                new TWEEN.Tween(page.rotation).to({ y: -Math.PI + 0.01 }, 1200).easing(TWEEN.Easing.Quartic.InOut).start();
                new TWEEN.Tween(page.position).to({ z: currentIndex * 0.03 + 0.1 }, 1200).start();
                currentIndex++;
            } else if (direction === 'prev' && currentIndex > 0) {
                currentIndex--;
                const page = meshPages[currentIndex];
                new TWEEN.Tween(page.rotation).to({ y: 0 }, 1200).easing(TWEEN.Easing.Quartic.InOut).start();
                new TWEEN.Tween(page.position).to({ z: -(currentIndex * 0.03) }, 1200).start();
            }

            // Dịch chuyển tâm quyển sách
            new TWEEN.Tween(bookGroup.position).to({ x: currentIndex === 0 ? -W/2 : 0 }, 1000).easing(TWEEN.Easing.Cubic.InOut).start();
            updateUI();
        }

        function updateUI() {
            document.getElementById('prevBtn').disabled = (currentIndex === 0);
            document.getElementById('nextBtn').disabled = (currentIndex === meshPages.length - 1);
        }

        function animate() {
            requestAnimationFrame(animate);
            TWEEN.update();
            renderer.render(scene, camera);
        }

        document.getElementById('nextBtn').onclick = () => flip('next');
        document.getElementById('prevBtn').onclick = () => flip('prev');
        init();
    </script>
</body>
</html>
